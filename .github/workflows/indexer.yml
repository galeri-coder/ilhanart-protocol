name: Ilhan Art - FPP Indexer (Production)

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:

concurrency:
  group: fpp-indexer
  cancel-in-progress: true

jobs:
  indexer:
    name: Run & Archive
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: "packages/indexer/package-lock.json"

      - name: Install Deps
        working-directory: packages/indexer
        run: npm ci

      - name: Run Sampling
        working-directory: packages/indexer
        env:
          RPC_URL: ${{ secrets.SOLANA_RPC_URL }}
          MINT: ${{ secrets.SPL_MINT_ADDRESS }}
        run: |
          set -euo pipefail          
          : "${RPC_URL:?Missing secret SOLANA_RPC_URL}"
          : "${MINT:?Missing secret SPL_MINT_ADDRESS}"

          NOW_TS=$(date -u +%s)
          ISO_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          echo "Starting sampling task at $ISO_DATE ($NOW_TS)..."

          mkdir -p ../../data

          npx ts-node src/cli.ts sample \
            --rpc "$RPC_URL" \
            --mint "$MINT" \
            --db "../../data/fp.db" \
            --ts "$NOW_TS"

          cat > ../../data/last_run.json <<EOF
          {
            "last_update": "$ISO_DATE",
            "timestamp": $NOW_TS,
            "mint": "$MINT",
            "status": "active",
            "system": "F.P.P. Indexer V1.0"
          }
          EOF

      - name: Upload DB Artifact
        uses: actions/upload-artifact@v4
        with:
          name: fpp-database-${{ github.run_id }}
          path: data/fp.db
          if-no-files-found: error
          retention-days: 30

      - name: Commit Heartbeat
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(status): update system heartbeat [skip ci]"
          file_pattern: "data/last_run.json"